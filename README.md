# Home Library Service

## Prerequisites

- Git - [Download & Install Git](https://git-scm.com/downloads).
- Node.js - [Download & Install Node.js](https://nodejs.org/en/download/) and the npm package manager (v22.14.0 or higher).
- Docker - [Download & Install Docker](https://docs.docker.com/engine/install/) (for containerized deployment).
- Docker Compose - [Download & Install Docker Compose](https://docs.docker.com/compose/install/) (v2.0 or higher).

## Downloading

```
git clone {repository URL}
```

## Running with Docker (Recommended)

check [DOCKER.md](./DOCKER.md) for detailed instructions.

### Quick Start - Development

```bash
# Copy environment variables
cp .env.example .env

# Build and start development containers
npm run docker:build:dev
npm run docker:up:dev

# Application will be available at http://localhost:4000
# View logs
npm run docker:logs:dev

# Stop containers
npm run docker:down:dev
```

### Production Deployment

```bash
# Edit .env with your production values

# Build and start production containers
npm run docker:build
npm run docker:up

# Stop containers
npm run docker:down
```

For detailed Docker instructions, see [DOCKER.md](./DOCKER.md).

## Running without Docker (Development, requires PostgreSQL on port 5432)

### Installing NPM modules

```
npm install
```

### Building application

```
npm run build
```

### Running application

```
npm start
```

After starting the app on port (4000 as default) you can open
in your browser OpenAPI documentation by typing http://localhost:4000/doc/.
For more information about OpenAPI/Swagger please visit https://swagger.io/.

## API Documentation

Folder [doc](doc) contains OpenAPI documentation in YAML format:
- `api-generated.yaml` - generated by NestJS Swagger module.
- `api.yaml` - initial documentation file adjusted to match the implementation.

To generate documentation run:

```
npm run build
```

## Testing

**Important**: Tests require a clean database state. If tests fail with 409 Conflict errors, clear the database first.

### Prerequisites for Testing
- Application must be running (use Docker or local setup)
- Database should be in clean state for reliable test results

### Test Commands

```bash
# Run all tests without authorization
npm run test

# Run specific test suite
npm run test -- <path to suite>

# Run all tests with authorization (currently not implemented)
npm run test:auth

# Run specific test suite with authorization
npm run test:auth -- <path to suite>
```

### Database Testing Notes

**PostgreSQL Data Persistence**: Unlike in-memory storage, PostgreSQL retains data between test runs. This can cause:
- **409 Conflict errors** when tests try to create users with existing logins
- **Test failures** due to unexpected existing data
- **Inconsistent test results** without proper cleanup

**Before Running Tests**: If you encounter 409 Conflict errors or test failures, clear the database:

```bash
# Reset database to clean state (removes all data and reapplies migrations)
npm run db:reset

# Quick reset without confirmation (recommended for development)
npm run db:reset:force

# Alternative: manually delete test data via API endpoints
# Example: DELETE http://localhost:4000/user/{id}
```

### Test Troubleshooting

| Error | Cause | Solution |
|-------|-------|----------|
| 409 Conflict | Existing user with same login | `npm run db:reset` |
| Connection refused | Application not running | Start with `npm run docker:up:dev` |
| Database errors | Schema out of sync | `npm run db:reset` |

## Database Scripts

### Schema Management

```bash
# Generate Prisma client from schema
npm run db:generate

# Clean generated files (Prisma clients)
npm run db:clean
```

### Development Database

```bash
# Create and apply new migration
npm run db:migrate

# Push schema changes to database (prototyping)
npm run db:push

# Reset database and apply all migrations (⚠️  REMOVES ALL DATA)
npm run db:reset

# Seed database with sample data (if seed script exists)
npm run db:seed

# Open Prisma Studio (database browser)
npm run db:studio
```

### Database Management

```bash
# Clear all data and reset to clean state (recommended before testing)
npm run db:reset

# Clear database without confirmation prompt (for scripts/automation)
npm run db:reset:force

# Deploy migrations only (production-safe)
npm run db:migrate:deploy

# Generate Prisma client after schema changes
npm run db:generate
```

**⚠️ Important Notes**:
- Database scripts require PostgreSQL connection except for `db:clean`
- `db:reset` **REMOVES ALL DATA** - use with caution
- All `start` scripts automatically run database migrations before starting
- Use `start:prod:no-migrate` if you need to skip migrations
- For testing, always start with a clean database using `npm run db:reset`

### Auto-fix and format

```
npm run lint
```

```
npm run format
```

### Debugging in VSCode

Press <kbd>F5</kbd> to debug.

For more information, visit: https://code.visualstudio.com/docs/editor/debugging
